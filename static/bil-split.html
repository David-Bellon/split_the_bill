<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitio - Dividir Cuenta</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Html2Canvas for screenshots -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Space Mono', 'monospace'],
                    },
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#10B981', // Emerald 500
                    }
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Smooth transitions for list items */
        .list-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .receipt-tear {
            background-image: radial-gradient(circle at center, transparent 4px, #ffffff 5px);
            background-size: 16px 16px;
            background-position: bottom;
            background-repeat: repeat-x;
            height: 12px;
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen pb-20">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <i class="fa-solid fa-file-invoice-dollar text-primary"></i> Splitio
            </h1>
            <button onclick="resetApp()" class="text-sm text-gray-500 hover:text-red-500 transition-colors">
                Reiniciar
            </button>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <!-- Bill Name Input -->
        <div class="bg-white rounded-xl shadow-sm p-4 flex items-center gap-3">
            <i class="fa-solid fa-pen text-gray-400"></i>
            <input type="text" id="billNameInput" placeholder="Nombre de la cuenta (ej. Comida Domingo)" 
                class="flex-1 text-lg font-bold text-gray-800 outline-none placeholder-gray-300"
                onchange="updateBillName(this.value)">
        </div>

        <!-- Step 1: People -->
        <section class="bg-white rounded-2xl shadow-sm p-5 list-enter">
            <h2 class="text-sm uppercase tracking-wide text-gray-500 font-semibold mb-3 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs">1</span>
                ¿Quién va a comer?
            </h2>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="personInput" placeholder="Nombre (ej. Alicia)" 
                    class="flex-1 bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-xl focus:ring-primary focus:border-primary block p-3 outline-none transition-all"
                    onkeypress="handleEnter(event, addPerson)">
                <button onclick="addPerson()" 
                    class="bg-gray-900 text-white hover:bg-gray-800 rounded-xl px-4 py-2 transition-colors">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div id="peopleList" class="flex flex-wrap gap-2">
                <!-- People chips will go here -->
                <p class="text-gray-400 text-sm italic w-full text-center py-2" id="emptyPeopleMsg">Nadie añadido aún.</p>
            </div>
        </section>

        <!-- Step 2: Items -->
        <section class="bg-white rounded-2xl shadow-sm p-5 list-enter" id="itemsSection">
            <h2 class="text-sm uppercase tracking-wide text-gray-500 font-semibold mb-3 flex items-center gap-2">
                <span class="bg-purple-100 text-purple-600 rounded-full w-6 h-6 flex items-center justify-center text-xs">2</span>
                ¿Qué habéis pedido?
            </h2>

            <!-- Hidden File Input -->
            <input type="file" id="billUploadInput" accept="image/*" class="hidden" onchange="handleBillUpload(this)">

            <!-- Method Selection: Scan or Manual -->
            <div class="mb-4">
                <button onclick="document.getElementById('billUploadInput').click()" 
                    class="w-full bg-indigo-50 hover:bg-indigo-100 text-primary border border-indigo-200 border-dashed rounded-xl py-4 flex flex-col items-center justify-center gap-2 transition-all mb-4 group">
                    <div class="bg-white p-2 rounded-full shadow-sm group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-camera text-xl"></i>
                    </div>
                    <span class="font-medium text-sm">Subir Foto de la Cuenta</span>
                </button>
                
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-100"></div>
                    <span class="flex-shrink-0 mx-4 text-gray-300 text-xs uppercase font-bold">O Añadir Manualmente</span>
                    <div class="flex-grow border-t border-gray-100"></div>
                </div>
            </div>

            <!-- Manual Entry Form -->
            <div class="grid grid-cols-6 gap-2 mb-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                <div class="col-span-6">
                    <label class="block text-xs text-gray-500 mb-1">Nombre del Artículo</label>
                    <input type="text" id="itemName" placeholder="ej. Pizza" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm focus:border-primary outline-none">
                </div>
                <div class="col-span-3">
                    <label class="block text-xs text-gray-500 mb-1">Precio</label>
                    <input type="number" id="itemPrice" placeholder="0.00" step="0.01" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm focus:border-primary outline-none">
                </div>
                <div class="col-span-3">
                    <label class="block text-xs text-gray-500 mb-1">Cant.</label>
                    <div class="flex items-center bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <button onclick="adjustQty(-1)" class="px-3 py-2 text-gray-500 hover:bg-gray-100">-</button>
                        <input type="number" id="itemQty" value="1" min="1" class="w-full text-center text-sm outline-none appearance-none" style="-moz-appearance: textfield;">
                        <button onclick="adjustQty(1)" class="px-3 py-2 text-gray-500 hover:bg-gray-100">+</button>
                    </div>
                </div>
                <button onclick="addItem()" class="col-span-6 mt-2 bg-gray-800 text-white rounded-lg py-2.5 font-medium shadow-md hover:bg-gray-900 active:transform active:scale-95 transition-all">
                    Añadir Artículo
                </button>
            </div>

            <div id="itemsList" class="space-y-4">
                <!-- Item Cards will go here -->
                <p class="text-gray-400 text-sm italic text-center py-4" id="emptyItemsMsg">No hay artículos aún.</p>
            </div>
        </section>

        <!-- Step 3: Summary -->
        <section class="list-enter">
            <div class="flex justify-between items-center mb-3 px-2">
                <h2 class="text-sm uppercase tracking-wide text-gray-500 font-semibold flex items-center gap-2">
                    <span class="bg-green-100 text-green-600 rounded-full w-6 h-6 flex items-center justify-center text-xs">3</span>
                    Recibo Final
                </h2>
                <!-- Payer Selector -->
                <select id="payerSelect" onchange="updatePayer(this.value)" class="text-xs bg-white border border-gray-300 rounded-lg px-2 py-1 outline-none focus:border-primary">
                    <option value="">¿Quién pagó?</option>
                </select>
            </div>
            
            <div class="bg-white p-6 shadow-lg relative mb-4 rounded-t-lg min-h-[200px]" id="receiptCard">
                <div class="text-center mb-6 border-b border-dashed border-gray-300 pb-4">
                    <h3 class="font-mono text-xl font-bold tracking-tighter text-gray-800 uppercase" id="receiptBillName">CUENTA TOTAL</h3>
                    <p class="text-gray-400 text-xs mt-1" id="receiptDate">Dec 22, 2025</p>
                    <div id="payerBadge" class="hidden mt-2 inline-block bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">
                        Pagado por <span id="payerBadgeName"></span>
                    </div>
                </div>

                <div id="receiptContent" class="space-y-6">
                    <!-- Calculated split goes here -->
                    <div class="text-center text-gray-400 italic text-sm">Añade personas y artículos para ver la división.</div>
                </div>

                <!-- Settlement Section -->
                <div id="settlementSection" class="hidden mt-6 pt-4 border-t border-gray-100">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Ajuste de Cuentas</h4>
                    <div id="settlementList" class="space-y-1 text-sm font-mono text-gray-600"></div>
                </div>

                <div class="mt-8 pt-4 border-t-2 border-gray-800 flex justify-between items-end">
                    <span class="font-mono text-sm font-bold">TOTAL FINAL</span>
                    <span class="font-mono text-2xl font-bold text-gray-900" id="grandTotalDisplay">$0.00</span>
                </div>
                
                <!-- Jagged edge effect -->
                <div class="receipt-tear"></div>
            </div>

            <!-- Share Button -->
            <button onclick="shareReceipt()" class="w-full bg-gray-900 text-white rounded-xl py-3 font-medium shadow-lg hover:bg-gray-800 transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-share-nodes"></i> Compartir Recibo
            </button>
        </section>

    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50">
        Acción completada
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60] flex items-center justify-center backdrop-blur-sm transition-all">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-xs w-full mx-4">
            <div class="mb-4">
                <i class="fa-solid fa-circle-notch fa-spin text-primary text-3xl"></i>
            </div>
            <p class="text-base font-bold text-gray-800" id="loadingTitle">Procesando</p>
            <p class="text-xs text-gray-500 mt-1" id="loadingText">Por favor espera...</p>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================

        // --- State Management ---
        let state = {
            billName: '',
            payerId: '',
            people: [], // { id, name }
            items: []   // { id, name, price, qty, assignedTo: [personIds] }
        };
        
        let editingItemId = null;

        // Load from local storage if available
        const savedState = localStorage.getItem('fairshare_state');
        if (savedState) {
            state = JSON.parse(savedState);
        }

        // --- DOM Elements ---
        const els = {
            billNameInput: document.getElementById('billNameInput'),
            payerSelect: document.getElementById('payerSelect'),
            
            personInput: document.getElementById('personInput'),
            peopleList: document.getElementById('peopleList'),
            emptyPeopleMsg: document.getElementById('emptyPeopleMsg'),
            
            itemName: document.getElementById('itemName'),
            itemPrice: document.getElementById('itemPrice'),
            itemQty: document.getElementById('itemQty'),
            itemsList: document.getElementById('itemsList'),
            emptyItemsMsg: document.getElementById('emptyItemsMsg'),
            
            receiptCard: document.getElementById('receiptCard'),
            receiptContent: document.getElementById('receiptContent'),
            receiptBillName: document.getElementById('receiptBillName'),
            receiptDate: document.getElementById('receiptDate'),
            grandTotalDisplay: document.getElementById('grandTotalDisplay'),
            payerBadge: document.getElementById('payerBadge'),
            payerBadgeName: document.getElementById('payerBadgeName'),
            settlementSection: document.getElementById('settlementSection'),
            settlementList: document.getElementById('settlementList'),
            
            toast: document.getElementById('toast'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingTitle: document.getElementById('loadingTitle'),
            loadingText: document.getElementById('loadingText')
        };

        els.receiptDate.textContent = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric'});
        els.billNameInput.value = state.billName || '';

        // --- Core Functions ---

        function saveState() {
            localStorage.setItem('fairshare_state', JSON.stringify(state));
            render();
        }

        function resetApp() {
            if(confirm("¿Empezar una nueva cuenta? Esto borrará todos los datos.")) {
                state = { billName: '', payerId: '', people: [], items: [] };
                els.billNameInput.value = '';
                saveState();
            }
        }

        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function showToast(msg) {
            els.toast.textContent = msg;
            els.toast.classList.remove('opacity-0');
            setTimeout(() => els.toast.classList.add('opacity-0'), 2000);
        }

        function showLoading(title, text) {
            els.loadingTitle.textContent = title;
            els.loadingText.textContent = text;
            els.loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            els.loadingOverlay.classList.add('hidden');
        }

        function handleEnter(e, callback) {
            if (e.key === 'Enter') callback();
        }

        function updateBillName(val) {
            state.billName = val;
            saveState();
        }

        function updatePayer(id) {
            state.payerId = id;
            saveState();
        }

        // --- Backend Image Upload Logic ---

        // Convert File to Base64 and resize to 1080x1920
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        // Target size
                        const targetW = 748;
                        const targetH = 748;
                        // Calculate scale to fit image within target
                        const scale = Math.min(targetW / img.width, targetH / img.height);
                        const newW = Math.round(img.width * scale);
                        const newH = Math.round(img.height * scale);
                        // Center the image
                        const offsetX = Math.floor((targetW - newW) / 2);
                        const offsetY = Math.floor((targetH - newH) / 2);
                        // Create canvas
                        const canvas = document.createElement('canvas');
                        canvas.width = targetW;
                        canvas.height = targetH;
                        const ctx = canvas.getContext('2d');
                        // Fill background white
                        ctx.fillStyle = '#fff';
                        ctx.fillRect(0, 0, targetW, targetH);
                        // Draw resized image centered
                        ctx.drawImage(img, offsetX, offsetY, newW, newH);
                        // Export as JPEG (smaller size, good for receipts)
                        resolve(canvas.toDataURL('image/jpeg', 0.92));
                    };
                    img.onerror = (e) => reject(e);
                    img.src = reader.result;
                };
                reader.onerror = error => reject(error);
            });
        }

        async function handleBillUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                const imageFile = await fileToBase64(file)
                showLoading("Analizando Recibo", "Subiendo imagen a la IA...");

                try {
                    // Real Fetch Request
                    const response = await fetch('/process-receipt', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image: imageFile
                        })
                    });

                    if (!response.ok) throw new Error(`Server Error: ${response.statusText}`);
                    
                    const data = await response.json();
                    processBackendResponse(data);

                } catch (error) {
                    console.error('Error:', error);
                    alert("Fallo al analizar el recibo. " + error.message);
                } finally {
                    hideLoading();
                    input.value = ''; // Reset input so same file can be selected again
                }
            }
        }

        function processBackendResponse(data) {
            // Expecting: { items: [ { item, quantity, price }, ... ] }
            if (!data || !Array.isArray(data.items)) {
                alert("Formato de respuesta inválido del servidor.");
                return;
            }

            const items = data.items;
            let count = 0;
            const newItems = [];
            
            items.forEach(entry => {
                if (entry && entry.item && entry.price) {
                    const price = parseFloat(entry.price);
                    const qty = parseInt(entry.quantity) || 1;
                    
                    if (!isNaN(price)) {
                        newItems.push({
                            id: generateId(),
                            name: entry.item,
                            price: price,
                            qty: qty,
                            assignedTo: [] 
                        });
                        count++;
                    }
                }
            });

            state.items = [...state.items, ...newItems];
            saveState();
            showToast(`¡Añadidos ${count} artículos del recibo!`);
        }

        // --- People Logic ---

        function addPerson() {
            const name = els.personInput.value.trim();
            if (!name) return;

            const newPerson = { id: generateId(), name: name };
            state.people.push(newPerson);
            
            els.personInput.value = '';
            showToast(`${name} añadido/a`);
            saveState();
        }

        function removePerson(id) {
            state.people = state.people.filter(p => p.id !== id);
            state.items.forEach(item => {
                item.assignedTo = item.assignedTo.filter(pid => pid !== id);
            });
            if (state.payerId === id) state.payerId = '';
            saveState();
        }

        // --- Item Logic ---

        function adjustQty(delta) {
            const current = parseInt(els.itemQty.value) || 0;
            const newVal = Math.max(1, current + delta);
            els.itemQty.value = newVal;
        }

        function addItem() {
            const name = els.itemName.value.trim();
            const price = parseFloat(els.itemPrice.value);
            const qty = parseInt(els.itemQty.value);

            if (!name || isNaN(price) || isNaN(qty) || qty < 1) {
                alert("Por favor introduce un nombre, precio y cantidad válidos.");
                return;
            }

            const newItem = {
                id: generateId(),
                name,
                price,
                qty,
                assignedTo: [] 
            };

            state.items.push(newItem);
            
            els.itemName.value = '';
            els.itemPrice.value = '';
            els.itemQty.value = '1';
            els.itemName.focus();
            
            showToast('Artículo añadido');
            saveState();
        }

        function removeItem(id) {
            state.items = state.items.filter(i => i.id !== id);
            saveState();
        }

        function splitItem(id) {
            const index = state.items.findIndex(i => i.id === id);
            if (index === -1) return;
            
            const item = state.items[index];
            if (item.qty <= 1) return;

            // Decrement original
            item.qty--;

            // Create new single item
            const newItem = {
                id: generateId(),
                name: item.name,
                price: item.price,
                qty: 1,
                assignedTo: [] // Start unassigned for clarity so user knows to assign it
            };

            // Insert after current item
            state.items.splice(index + 1, 0, newItem);
            saveState();
            showToast('Artículo dividido en dos líneas');
        }

        // --- Edit Logic ---

        function startEdit(id) {
            editingItemId = id;
            render();
        }

        function cancelEdit() {
            editingItemId = null;
            render();
        }

        function saveEdit(id) {
            const nameInput = document.getElementById(`edit-name-${id}`);
            const priceInput = document.getElementById(`edit-price-${id}`);
            const qtyInput = document.getElementById(`edit-qty-${id}`);

            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const qty = parseInt(qtyInput.value);

            if (!name || isNaN(price) || isNaN(qty) || qty < 1) {
                alert("Por favor introduce detalles válidos.");
                return;
            }

            const itemIndex = state.items.findIndex(i => i.id === id);
            if (itemIndex > -1) {
                state.items[itemIndex].name = name;
                state.items[itemIndex].price = price;
                state.items[itemIndex].qty = qty;
                showToast("Artículo actualizado");
            }

            editingItemId = null;
            saveState();
        }

        function toggleAssignment(itemId, personId) {
            const item = state.items.find(i => i.id === itemId);
            if (!item) return;

            if (item.assignedTo.includes(personId)) {
                item.assignedTo = item.assignedTo.filter(id => id !== personId);
            } else {
                item.assignedTo.push(personId);
            }
            saveState();
        }

        function toggleAllAssignment(itemId) {
            const item = state.items.find(i => i.id === itemId);
            if (!item) return;

            const allSelected = state.people.every(p => item.assignedTo.includes(p.id));
            if (allSelected) {
                item.assignedTo = [];
            } else {
                item.assignedTo = state.people.map(p => p.id);
            }
            saveState();
        }

        // --- Sharing Logic ---

        async function shareReceipt() {
            showLoading("Generando Imagen", "Creando captura...");
            
            const originalShadow = els.receiptCard.style.boxShadow;
            els.receiptCard.style.boxShadow = 'none';
            els.receiptCard.style.backgroundColor = '#ffffff';

            try {
                const canvas = await html2canvas(els.receiptCard, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true
                });

                els.receiptCard.style.boxShadow = originalShadow;

                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `receipt_${Date.now()}.png`, { type: "image/png" });

                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                files: [file],
                                title: state.billName || 'Bill Receipt',
                                text: 'Aquí está el desglose de la cuenta.'
                            });
                            showToast('¡Compartido con éxito!');
                        } catch (shareError) {
                            if (shareError.name !== 'AbortError') {
                                console.error('Share failed:', shareError);
                                downloadImage(canvas);
                            }
                        }
                    } else {
                        downloadImage(canvas);
                    }
                    hideLoading();
                }, 'image/png');

            } catch (err) {
                console.error(err);
                hideLoading();
                alert("No se pudo generar la imagen. " + err.message);
            }
        }

        function downloadImage(canvas) {
            const link = document.createElement('a');
            link.download = `receipt_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showToast('Recibo descargado');
        }

        // --- Rendering ---

        function formatCurrency(num) {
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(num);
        }

        function renderPeople() {
            els.peopleList.innerHTML = '';
            els.payerSelect.innerHTML = '<option value="">¿Quién pagó?</option>';

            if (state.people.length === 0) {
                els.emptyPeopleMsg.style.display = 'block';
                return;
            }
            els.emptyPeopleMsg.style.display = 'none';

            state.people.forEach(person => {
                const chip = document.createElement('div');
                chip.className = 'bg-gray-100 border border-gray-200 text-gray-800 rounded-full px-3 py-1 text-sm flex items-center gap-2 animate-fade-in';
                chip.innerHTML = `
                    <span class="font-medium truncate max-w-[100px]">${person.name}</span>
                    <button onclick="removePerson('${person.id}')" class="text-gray-400 hover:text-red-500 rounded-full w-4 h-4 flex items-center justify-center">
                        <i class="fa-solid fa-times text-xs"></i>
                    </button>
                `;
                els.peopleList.appendChild(chip);

                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                if (person.id === state.payerId) option.selected = true;
                els.payerSelect.appendChild(option);
            });
        }

        function renderItems() {
            els.itemsList.innerHTML = '';
            if (state.items.length === 0) {
                els.emptyItemsMsg.style.display = 'block';
                return;
            }
            els.emptyItemsMsg.style.display = 'none';

            state.items.forEach(item => {
                // EDIT MODE
                if (editingItemId === item.id) {
                    const div = document.createElement('div');
                    div.className = 'bg-white border-2 border-primary rounded-xl p-4 shadow-md relative list-enter';
                    div.innerHTML = `
                        <div class="space-y-3">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="text-xs font-bold text-primary uppercase tracking-wide">Editando Artículo</h3>
                            </div>
                            <div>
                                <label class="block text-[10px] text-gray-400 uppercase font-bold mb-1">Nombre del Artículo</label>
                                <input type="text" id="edit-name-${item.id}" value="${item.name}" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all">
                            </div>
                            <div class="flex gap-3">
                                <div class="flex-1">
                                    <label class="block text-[10px] text-gray-400 uppercase font-bold mb-1">Precio</label>
                                    <input type="number" id="edit-price-${item.id}" value="${item.price}" step="0.01" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all">
                                </div>
                                <div class="w-24">
                                    <label class="block text-[10px] text-gray-400 uppercase font-bold mb-1">Cant.</label>
                                    <input type="number" id="edit-qty-${item.id}" value="${item.qty}" min="1" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all">
                                </div>
                            </div>
                            <div class="flex justify-end gap-2 pt-2">
                                <button onclick="cancelEdit()" class="px-4 py-2 bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-lg text-xs font-bold transition-colors">Cancelar</button>
                                <button onclick="saveEdit('${item.id}')" class="px-4 py-2 bg-primary text-white hover:bg-indigo-700 rounded-lg text-xs font-bold shadow-sm transition-colors">Guardar Cambios</button>
                            </div>
                        </div>
                    `;
                    els.itemsList.appendChild(div);
                    return;
                }

                // NORMAL MODE
                const totalCost = item.price * item.qty;
                const isUnassigned = item.assignedTo.length === 0;
                const canSplit = item.qty > 1;

                const div = document.createElement('div');
                div.className = `bg-white border ${isUnassigned ? 'border-orange-200' : 'border-gray-100'} rounded-xl p-4 shadow-sm transition-all hover:shadow-md relative`;
                
                let html = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="pr-2">
                            <h3 class="font-bold text-gray-900 leading-tight">${item.name}</h3>
                            <div class="text-xs text-gray-500 mt-1">
                                ${item.qty} x ${formatCurrency(item.price)}
                            </div>
                        </div>
                        <div class="text-right whitespace-nowrap">
                            <div class="font-mono font-bold text-gray-800">${formatCurrency(totalCost)}</div>
                            <div class="flex gap-1 justify-end mt-1 items-center">
                                <button onclick="startEdit('${item.id}')" class="text-xs text-blue-400 hover:text-blue-600 px-1.5 py-1 rounded hover:bg-blue-50 transition-colors" title="Editar"><i class="fa-solid fa-pen"></i></button>
                                ${canSplit ? `<button onclick="splitItem('${item.id}')" class="text-xs text-indigo-400 hover:text-indigo-600 px-1.5 py-1 rounded hover:bg-indigo-50 transition-colors" title="Dividir"><i class="fa-solid fa-scissors"></i></button>` : ''}
                                <button onclick="removeItem('${item.id}')" class="text-xs text-red-300 hover:text-red-500 px-1.5 py-1 rounded hover:bg-red-50 transition-colors" title="Borrar"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                `;

                if (isUnassigned && state.people.length > 0) {
                    html += `<div class="text-[10px] text-orange-500 font-bold mb-2 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-1"></i> ¡Sin asignar! Toca personas abajo.</div>`;
                }

                html += `<div class="border-t border-gray-50 pt-3">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-xs text-gray-400 uppercase font-semibold">Compartido por:</span>
                                <button onclick="toggleAllAssignment('${item.id}')" class="text-[10px] text-primary hover:underline">Todos</button>
                            </div>
                            <div class="flex flex-wrap gap-2">`;

                if (state.people.length === 0) {
                    html += `<span class="text-xs text-gray-400 italic">Añade personas arriba para asignar.</span>`;
                } else {
                    state.people.forEach(person => {
                        const isAssigned = item.assignedTo.includes(person.id);
                        html += `
                            <button onclick="toggleAssignment('${item.id}', '${person.id}')" 
                                class="text-xs px-2.5 py-1.5 rounded-lg border transition-all duration-200 ${isAssigned 
                                    ? 'bg-indigo-50 border-primary text-primary font-medium shadow-sm ring-1 ring-primary ring-opacity-10' 
                                    : 'bg-white border-gray-200 text-gray-400 hover:border-gray-300'}">
                                ${person.name}
                            </button>
                        `;
                    });
                }
                
                html += `   </div>
                        </div>`;
                div.innerHTML = html;
                els.itemsList.appendChild(div);
            });
        }

        function renderReceipt() {
            const personTotals = {}; 
            let grandTotal = 0;
            let unclaimedTotal = 0;

            state.people.forEach(p => personTotals[p.id] = 0);

            state.items.forEach(item => {
                const totalCost = item.price * item.qty;
                grandTotal += totalCost;
                if (item.assignedTo.length > 0) {
                    const splitAmount = totalCost / item.assignedTo.length;
                    item.assignedTo.forEach(pid => {
                        if (personTotals[pid] !== undefined) personTotals[pid] += splitAmount;
                    });
                } else {
                    unclaimedTotal += totalCost;
                }
            });

            // Update UI Header
            els.receiptBillName.textContent = state.billName || 'CUENTA TOTAL';
            els.grandTotalDisplay.textContent = formatCurrency(grandTotal);

            // Update Payer Badge
            const payer = state.people.find(p => p.id === state.payerId);
            if (payer) {
                els.payerBadge.classList.remove('hidden');
                els.payerBadge.classList.add('inline-block');
                els.payerBadgeName.textContent = payer.name;
            } else {
                els.payerBadge.classList.add('hidden');
                els.payerBadge.classList.remove('inline-block');
            }

            // Render Content
            els.receiptContent.innerHTML = '';
            if (state.people.length === 0 && state.items.length === 0) {
                els.receiptContent.innerHTML = `<div class="text-center text-gray-400 italic text-sm py-4">Añade personas y artículos para ver la división.</div>`;
                els.settlementSection.classList.add('hidden');
                return;
            }

            // Breakdown Per Person
            state.people.forEach(person => {
                const amount = personTotals[person.id];
                const personItems = state.items.filter(i => i.assignedTo.includes(person.id));
                
                const div = document.createElement('div');
                div.className = 'border-b border-gray-100 pb-3 last:border-0';
                
                let detailsHtml = '';
                if (personItems.length > 0) {
                    detailsHtml = `
                        <div class="mt-1 pl-2 border-l-2 border-gray-100 space-y-1">
                            ${personItems.map(i => {
                                const share = (i.price * i.qty) / i.assignedTo.length;
                                return `<div class="flex justify-between text-xs text-gray-500">
                                            <span class="truncate w-3/4">${i.name} (1/${i.assignedTo.length})</span>
                                            <span>${formatCurrency(share)}</span>
                                        </div>`
                            }).join('')}
                        </div>
                    `;
                }

                div.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-gray-800">${person.name}</span>
                        <span class="font-mono font-bold text-lg ${amount > 0 ? 'text-primary' : 'text-gray-400'}">${formatCurrency(amount)}</span>
                    </div>
                    ${detailsHtml}
                `;
                els.receiptContent.appendChild(div);
            });

            // Unclaimed warning
            if (unclaimedTotal > 0.01) {
                const div = document.createElement('div');
                div.className = 'mt-4 bg-orange-50 p-3 rounded-lg border border-orange-100';
                div.innerHTML = `
                    <div class="flex justify-between items-center text-orange-700 font-bold text-sm">
                        <span><i class="fa-solid fa-circle-exclamation mr-1"></i> Artículos Sin Asignar</span>
                        <span>${formatCurrency(unclaimedTotal)}</span>
                    </div>
                `;
                els.receiptContent.appendChild(div);
            }

            // Settlement Logic (If Payer Selected)
            if (payer) {
                els.settlementSection.classList.remove('hidden');
                els.settlementList.innerHTML = '';
                
                state.people.forEach(person => {
                    if (person.id === payer.id) return; // Skip the payer
                    const amountOwed = personTotals[person.id];
                    if (amountOwed > 0) {
                        const row = document.createElement('div');
                        row.innerHTML = `<span class="font-bold text-gray-800">${person.name}</span> debe a ${payer.name} <span class="font-bold text-primary">${formatCurrency(amountOwed)}</span>`;
                        els.settlementList.appendChild(row);
                    }
                });
                
                // If only one person and they paid everything, or everyone owes 0
                if (els.settlementList.children.length === 0) {
                    els.settlementList.innerHTML = `<div class="text-xs text-gray-400 italic">No hay deudas que saldar.</div>`;
                }
            } else {
                els.settlementSection.classList.add('hidden');
            }
        }

        function render() {
            renderPeople();
            renderItems();
            renderReceipt();
        }

        // Initialize
        render();

    </script>
</body>
</html>