<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitio - Dividir Cuenta</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Html2Canvas for screenshots -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-ZH07M1LR8N', {
            cookie_domain: 'auto'
        });
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['Space Mono', 'monospace'],
                    },
                    colors: {
                        primary: '#4F46E5', // Indigo 600
                        secondary: '#10B981', // Emerald 500
                    }
                }
            }
        }
    </script>
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Smooth transitions */
        .list-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .receipt-tear {
            background-image: radial-gradient(circle at center, transparent 4px, #ffffff 5px);
            background-size: 16px 16px;
            background-position: bottom;
            background-repeat: repeat-x;
            height: 12px;
            position: absolute;
            bottom: -8px;
            left: 0;
            right: 0;
            z-index: 10;
        }
        /* Checkbox custom style */
        .custom-checkbox:checked {
            background-color: #10B981;
            border-color: #10B981;
        }
        .custom-checkbox:checked + div {
            text-decoration: line-through;
            color: #9CA3AF;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen pb-24">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <i class="fa-solid fa-file-invoice-dollar text-primary"></i> Splitio
            </h1>
            <div id="headerActions">
                <button onclick="resetApp()" class="text-sm text-gray-500 hover:text-red-500 transition-colors">
                    <i class="fa-solid fa-rotate-right mr-1"></i> Reiniciar
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-4 relative">

        <!-- VIEW: CALCULATOR -->
        <div id="view-calculator" class="space-y-6">
            
            <!-- Bill Name Input -->
            <div class="bg-white rounded-xl shadow-sm p-4 flex items-center gap-3">
                <i class="fa-solid fa-pen text-gray-400"></i>
                <input type="text" id="billNameInput" placeholder="Nombre de la cuenta (ej. Comida Domingo)" 
                    class="flex-1 text-lg font-bold text-gray-800 outline-none placeholder-gray-300"
                    onchange="updateBillName(this.value)">
            </div>

            <!-- Step 1: People -->
            <section class="bg-white rounded-2xl shadow-sm p-5 list-enter">
                <h2 class="text-sm uppercase tracking-wide text-gray-500 font-semibold mb-3 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs">1</span>
                    ¿Quién va a comer?
                </h2>
                
                <div class="flex gap-2 mb-4">
                    <input type="text" id="personInput" placeholder="Nombre (ej. Alicia)" 
                        class="flex-1 bg-gray-50 border border-gray-200 text-gray-900 text-sm rounded-xl focus:ring-primary focus:border-primary block p-3 outline-none transition-all"
                        onkeypress="handleEnter(event, addPerson)">
                    <button onclick="addPerson()" 
                        class="bg-gray-900 text-white hover:bg-gray-800 rounded-xl px-4 py-2 transition-colors">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                </div>

                <div id="peopleList" class="flex flex-wrap gap-2">
                    <p class="text-gray-400 text-sm italic w-full text-center py-2" id="emptyPeopleMsg">Nadie añadido aún.</p>
                </div>
            </section>

            <!-- Step 2: Items -->
            <section class="bg-white rounded-2xl shadow-sm p-5 list-enter" id="itemsSection">
                <h2 class="text-sm uppercase tracking-wide text-gray-500 font-semibold mb-3 flex items-center gap-2">
                    <span class="bg-purple-100 text-purple-600 rounded-full w-6 h-6 flex items-center justify-center text-xs">2</span>
                    ¿Qué habéis pedido?
                </h2>

                <input type="file" id="billUploadInput" accept="image/*" class="hidden" onchange="handleBillUpload(this)">

                <div class="mb-4">
                    <button onclick="document.getElementById('billUploadInput').click()" 
                        class="w-full bg-indigo-50 hover:bg-indigo-100 text-primary border border-indigo-200 border-dashed rounded-xl py-4 flex flex-col items-center justify-center gap-2 transition-all mb-4 group">
                        <div class="bg-white p-2 rounded-full shadow-sm group-hover:scale-110 transition-transform">
                            <i class="fa-solid fa-camera text-xl"></i>
                        </div>
                        <span class="font-medium text-sm">Subir Foto de la Cuenta</span>
                    </button>
                    
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-100"></div>
                        <span class="flex-shrink-0 mx-4 text-gray-300 text-xs uppercase font-bold">O Añadir Manualmente</span>
                        <div class="flex-grow border-t border-gray-100"></div>
                    </div>
                </div>

                <!-- Manual Entry Form -->
                <div class="grid grid-cols-6 gap-2 mb-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="col-span-6">
                        <label class="block text-xs text-gray-500 mb-1">Nombre del Artículo</label>
                        <input type="text" id="itemName" placeholder="ej. Pizza" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm focus:border-primary outline-none">
                    </div>
                    <div class="col-span-3">
                        <label class="block text-xs text-gray-500 mb-1">Precio</label>
                        <input type="number" id="itemPrice" placeholder="0.00" step="0.01" class="w-full bg-white border border-gray-200 rounded-lg p-2 text-sm focus:border-primary outline-none">
                    </div>
                    <div class="col-span-3">
                        <label class="block text-xs text-gray-500 mb-1">Cant.</label>
                        <div class="flex items-center bg-white border border-gray-200 rounded-lg overflow-hidden">
                            <button onclick="adjustQty(-1)" class="px-3 py-2 text-gray-500 hover:bg-gray-100">-</button>
                            <input type="number" id="itemQty" value="1" min="1" class="w-full text-center text-sm outline-none appearance-none" style="-moz-appearance: textfield;">
                            <button onclick="adjustQty(1)" class="px-3 py-2 text-gray-500 hover:bg-gray-100">+</button>
                        </div>
                    </div>
                    <button onclick="addItem()" class="col-span-6 mt-2 bg-gray-800 text-white rounded-lg py-2.5 font-medium shadow-md hover:bg-gray-900 active:transform active:scale-95 transition-all">
                        Añadir Artículo
                    </button>
                </div>

                <div id="itemsList" class="space-y-4">
                    <p class="text-gray-400 text-sm italic text-center py-4" id="emptyItemsMsg">No hay artículos aún.</p>
                </div>
            </section>

            <!-- Collaborative Link Banner -->
            <div class="bg-blue-50 border border-blue-100 rounded-2xl p-5 flex flex-col items-center justify-center text-center list-enter shadow-sm">
                <div class="bg-white p-3 rounded-full shadow-sm text-blue-500 mb-3">
                    <i class="fa-solid fa-users text-xl"></i>
                </div>
                <h3 class="text-sm font-bold text-blue-900 mb-1">¿Es una cuenta muy grande?</h3>
                <p class="text-xs text-blue-700 mb-4 px-2">Genera un enlace y compártelo para que cada persona marque lo que ha consumido desde su móvil.</p>
                <button id="collabMainBtn" onclick="createCollabLink()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-3 px-4 rounded-xl transition-all shadow-md w-full flex items-center justify-center gap-2 active:scale-95">
                    <i id="collabBtnIcon" class="fa-solid fa-link"></i> <span id="collabBtnText">Crear Enlace Colaborativo</span>
                </button>
                
                <!-- Contenedor del enlace generado -->
                <div id="collabLinkContainer" class="hidden w-full mt-4 bg-white p-2 rounded-xl border border-blue-200 flex items-center gap-2 transition-all">
                    <input type="text" id="collabLinkInput" readonly class="flex-1 bg-transparent text-xs text-gray-600 outline-none px-2 truncate select-all">
                    <button onclick="copyCollabLink()" class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-2 rounded-lg text-xs font-bold transition-colors shadow-sm active:scale-95" title="Copiar enlace">
                        <i class="fa-solid fa-copy"></i>
                    </button>
                </div>
            </div>

            <!-- Step 3: Summary -->
            <section class="list-enter">
                <div class="flex justify-between items-center mb-3 px-2">
                    <h2 class="text-sm uppercase tracking-wide text-gray-500 font-semibold flex items-center gap-2">
                        <span class="bg-green-100 text-green-600 rounded-full w-6 h-6 flex items-center justify-center text-xs">3</span>
                        Recibo Final
                    </h2>
                    <select id="payerSelect" onchange="updatePayer(this.value)" class="text-xs bg-white border border-gray-300 rounded-lg px-2 py-1 outline-none focus:border-primary">
                        <option value="">¿Quién pagó?</option>
                    </select>
                </div>
                
                <div class="bg-white p-6 shadow-lg relative mb-4 rounded-t-lg min-h-[200px]" id="receiptCard">
                    <div class="text-center mb-6 border-b border-dashed border-gray-300 pb-4">
                        <h3 class="font-mono text-xl font-bold tracking-tighter text-gray-800 uppercase" id="receiptBillName">CUENTA TOTAL</h3>
                        <p class="text-gray-400 text-xs mt-1" id="receiptDate">Dec 22, 2025</p>
                        <div id="payerBadge" class="hidden mt-2 inline-block bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded uppercase tracking-wide">
                            Pagado por <span id="payerBadgeName"></span>
                        </div>
                    </div>

                    <div id="receiptContent" class="space-y-6">
                        <div class="text-center text-gray-400 italic text-sm">Añade personas y artículos para ver la división.</div>
                    </div>

                    <div id="settlementSection" class="hidden mt-6 pt-4 border-t border-gray-100">
                        <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Ajuste de Cuentas</h4>
                        <div id="settlementList" class="space-y-1 text-sm font-mono text-gray-600"></div>
                    </div>

                    <div class="mt-8 pt-4 border-t-2 border-gray-800 flex justify-between items-end">
                        <span class="font-mono text-sm font-bold">TOTAL FINAL</span>
                        <span class="font-mono text-2xl font-bold text-gray-900" id="grandTotalDisplay">$0.00</span>
                    </div>
                    
                    <div class="receipt-tear"></div>
                </div>

                <div class="grid grid-cols-2 gap-3" id="actionButtonsGrid">
                    <button onclick="shareReceipt()" class="bg-gray-900 text-white rounded-xl py-3 font-medium shadow-lg hover:bg-gray-800 transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-share-nodes"></i> Compartir
                    </button>
                    <button id="saveBillBtn" onclick="saveBillToHistory()" class="bg-secondary text-white rounded-xl py-3 font-medium shadow-lg hover:bg-green-600 transition-all flex items-center justify-center gap-2">
                        <i class="fa-solid fa-floppy-disk"></i> Guardar
                    </button>
                </div>
            </section>
        </div>

        <!-- VIEW: HISTORY -->
        <div id="view-history" class="hidden space-y-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900">Historial</h2>
                <div class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-xs font-bold" id="historyCount">0 cuentas</div>
            </div>

            <div id="historyList" class="space-y-4">
                <!-- History Items Render Here -->
                <div class="text-center text-gray-400 py-10">
                    <i class="fa-solid fa-clock-rotate-left text-4xl mb-3 opacity-20"></i>
                    <p>No hay cuentas guardadas aún.</p>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40 pb-safe">
        <div class="max-w-md mx-auto flex justify-around items-center">
            <button onclick="switchView('calculator')" class="flex-1 py-3 text-center transition-colors text-primary" id="nav-calc">
                <i class="fa-solid fa-calculator text-xl mb-1"></i>
                <div class="text-[10px] font-bold">Calculadora</div>
            </button>
            <button onclick="switchView('history')" class="flex-1 py-3 text-center transition-colors text-gray-400 hover:text-gray-600 relative" id="nav-hist">
                <i class="fa-solid fa-clock-rotate-left text-xl mb-1"></i>
                <div class="text-[10px] font-bold">Historial</div>
                <!-- Notification Badge -->
                <span id="historyBadge" class="hidden absolute top-2 right-1/4 translate-x-3 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-white shadow-sm">1</span>
            </button>
        </div>
    </nav>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-[60]">
        Acción completada
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[70] flex items-center justify-center backdrop-blur-sm transition-all">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-xs w-full mx-4">
            <div class="mb-4">
                <i class="fa-solid fa-circle-notch fa-spin text-primary text-3xl"></i>
            </div>
            <p class="text-base font-bold text-gray-800" id="loadingTitle">Procesando</p>
        </div>
    </div>

    <script>
        // --- State Management ---
        let state = {
            billName: '',
            payerId: '',
            people: [], 
            items: [],
            saved: false, // Track if current state is saved
            collabId: null, // Track collaborative session UUID
            historyId: null // Track which history item this corresponds to
        };
        
        // History Array
        let history = [];

        let editingItemId = null;
        let expandedBillId = null; // Track expanded history item
        let currentView = 'calculator';

        // Load State
        const savedState = localStorage.getItem('fairshare_state');
        if (savedState) state = JSON.parse(savedState);

        // Load History
        const savedHistory = localStorage.getItem('fairshare_history');
        if (savedHistory) history = JSON.parse(savedHistory);

        // --- DOM Elements ---
        const els = {
            // Calculator Inputs
            billNameInput: document.getElementById('billNameInput'),
            payerSelect: document.getElementById('payerSelect'),
            personInput: document.getElementById('personInput'),
            itemName: document.getElementById('itemName'),
            itemPrice: document.getElementById('itemPrice'),
            itemQty: document.getElementById('itemQty'),
            
            // Lists & Messages
            peopleList: document.getElementById('peopleList'),
            emptyPeopleMsg: document.getElementById('emptyPeopleMsg'),
            itemsList: document.getElementById('itemsList'),
            emptyItemsMsg: document.getElementById('emptyItemsMsg'),
            
            // Receipt
            receiptCard: document.getElementById('receiptCard'),
            receiptContent: document.getElementById('receiptContent'),
            receiptBillName: document.getElementById('receiptBillName'),
            receiptDate: document.getElementById('receiptDate'),
            grandTotalDisplay: document.getElementById('grandTotalDisplay'),
            payerBadge: document.getElementById('payerBadge'),
            payerBadgeName: document.getElementById('payerBadgeName'),
            settlementSection: document.getElementById('settlementSection'),
            settlementList: document.getElementById('settlementList'),
            
            // Buttons & Grids
            actionButtonsGrid: document.getElementById('actionButtonsGrid'),
            saveBillBtn: document.getElementById('saveBillBtn'),

            // Views
            viewCalculator: document.getElementById('view-calculator'),
            viewHistory: document.getElementById('view-history'),
            navCalc: document.getElementById('nav-calc'),
            navHist: document.getElementById('nav-hist'),
            historyBadge: document.getElementById('historyBadge'),
            headerActions: document.getElementById('headerActions'),
            historyList: document.getElementById('historyList'),
            historyCount: document.getElementById('historyCount'),
            
            // Global
            toast: document.getElementById('toast'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingTitle: document.getElementById('loadingTitle'),
            
            // Collab Link
            collabMainBtn: document.getElementById('collabMainBtn'),
            collabBtnIcon: document.getElementById('collabBtnIcon'),
            collabBtnText: document.getElementById('collabBtnText'),
            collabLinkContainer: document.getElementById('collabLinkContainer'),
            collabLinkInput: document.getElementById('collabLinkInput')
        };

        // Initialize Dates & Inputs
        const todayStr = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'short', day: 'numeric'});
        els.receiptDate.textContent = todayStr;
        els.billNameInput.value = state.billName || '';

        // --- View Switching ---

        function switchView(viewName) {
            currentView = viewName;
            if (viewName === 'calculator') {
                els.viewCalculator.classList.remove('hidden');
                els.viewHistory.classList.add('hidden');
                
                els.navCalc.classList.add('text-primary');
                els.navCalc.classList.remove('text-gray-400');
                els.navHist.classList.remove('text-primary');
                els.navHist.classList.add('text-gray-400');
                
                els.headerActions.style.display = 'block';
            } else {
                els.viewCalculator.classList.add('hidden');
                els.viewHistory.classList.remove('hidden');
                
                els.navCalc.classList.remove('text-primary');
                els.navCalc.classList.add('text-gray-400');
                els.navHist.classList.add('text-primary');
                els.navHist.classList.remove('text-gray-400');
                
                els.headerActions.style.display = 'none';
                
                // Clear badge when viewing history
                els.historyBadge.classList.add('hidden');
                renderHistory();
            }
        }

        // --- Core Functions ---

        function saveState() {
            localStorage.setItem('fairshare_state', JSON.stringify(state));
            render();
        }
        
        function saveHistory() {
            localStorage.setItem('fairshare_history', JSON.stringify(history));
            renderHistory();
        }

        function resetApp() {
            if(confirm("¿Empezar una nueva cuenta? Esto borrará todos los datos no guardados.")) {
                state = { billName: '', payerId: '', people: [], items: [], saved: false, collabId: null, historyId: null };
                els.billNameInput.value = '';
                saveState();
            }
        }

        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function showToast(msg) {
            els.toast.textContent = msg;
            els.toast.classList.remove('opacity-0');
            setTimeout(() => els.toast.classList.add('opacity-0'), 2000);
        }

        function showLoading(title) {
            els.loadingTitle.textContent = title;
            els.loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            els.loadingOverlay.classList.add('hidden');
        }

        function handleEnter(e, callback) {
            if (e.key === 'Enter') callback();
        }

        function updateBillName(val) {
            state.billName = val;
            state.saved = false;
            saveState();
        }

        function updatePayer(id) {
            state.payerId = id;
            state.saved = false;
            saveState();
        }

        // --- Collaborative Link Logic ---
        async function createCollabLink() {
            if (state.items.length === 0 || state.people.length === 0) {
                alert("Añade al menos una persona y un artículo primero.");
                return;
            }

            showLoading("Procesando enlace...");
            
            try {
                if (state.collabId) {
                    // 1. If link exists, fetch current server state first to preserve what friends selected
                    const getResponse = await fetch(`/api/bills/${state.collabId}`);
                    if (getResponse.ok) {
                        const serverState = await getResponse.json();
                        // Merge assignedTo arrays from the server into our local items
                        let hasChanges = false;
                        state.items.forEach(localItem => {
                            const serverItem = serverState.items.find(i => i.id === localItem.id);
                            if (serverItem && JSON.stringify(localItem.assignedTo) !== JSON.stringify(serverItem.assignedTo)) {
                                localItem.assignedTo = serverItem.assignedTo;
                                hasChanges = true;
                            }
                        });
                        if (hasChanges) state.saved = false;
                    }

                    // 2. Push the merged updated state to backend
                    const updateResponse = await fetch(`/api/bills/${state.collabId}/update`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(state)
                    });

                    if (!updateResponse.ok) throw new Error("Failed to update bill session.");
                    console.log("Cambios sincronizados al enlace");
                    showToast("Cambios sincronizados al enlace");
                    saveState(); // Save locally with merged data
                    
                    // 3. Auto-update History record if it exists and there are changes
                    if (state.historyId && !state.saved) {
                        saveBillToHistory(true); // true = silent (don't show a second toast)
                    }

                } else {
                    // Create new session
                    const response = await fetch('/api/bills/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(state)
                    });
                    
                    if (!response.ok) {
                        throw new Error("Failed to create bill session on server.");
                    }
                    
                    const data = await response.json();
                    state.collabId = data.uuid; 
                    state.saved = false; // Mark unsaved so history catches the collabId
                    showToast("¡Enlace generado! Cópialo abajo.");
                    saveState();
                    
                    // Auto-update history record if it was already saved BEFORE linking
                    if (state.historyId) {
                        saveBillToHistory(true); // true = silent
                    }
                }
                
                // Construct the URL pointing to the shared HTML file
                const shareUrl = window.location.origin + '/shared_bill/' + state.collabId;

                hideLoading();

                // Attempt to share
                const shareData = {
                    title: 'Dividir Cuenta Splitio',
                    text: 'Entra a este enlace y selecciona qué has comido: ',
                    url: shareUrl
                };
            } catch (error) {
                console.error("Error:", error);
                alert("Hubo un error al procesar el enlace.");
                hideLoading();
            }
        }

        function copyCollabLink() {
            const copyText = els.collabLinkInput.value;
            if(!copyText) return;
            
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(copyText).then(() => {
                    showToast("Enlace copiado");
                });
            } else {
                els.collabLinkInput.select();
                document.execCommand("copy");
                showToast("Enlace copiado");
            }
        }

        function renderCollabUI() {
            if (state.collabId) {
                // Show link container
                const shareUrl = window.location.origin + '/shared_bill/' + state.collabId;
                els.collabLinkInput.value = shareUrl;
                els.collabLinkContainer.classList.remove('hidden');
                
                // Update Button to "Sync"
                els.collabBtnText.textContent = "Sobreescribir Cambios al Enlace";
                els.collabBtnIcon.className = "fa-solid fa-rotate";
                els.collabMainBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                els.collabMainBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            } else {
                // Hide link container
                els.collabLinkContainer.classList.add('hidden');
                els.collabLinkInput.value = '';
                
                // Reset Button to "Create"
                els.collabBtnText.textContent = "Crear Enlace Colaborativo";
                els.collabBtnIcon.className = "fa-solid fa-link";
                els.collabMainBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                els.collabMainBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            }
        }

        // --- History Logic ---

        function saveBillToHistory(silent = false) {
            if (state.items.length === 0 && state.people.length === 0) {
                if (!silent) alert("La cuenta está vacía.");
                return;
            }

            if (state.saved) return; // Prevention, though button is hidden

            // Calculate current debts snapshot using PROPORTIONAL logic
            const debts = []; 
            const personTotals = {};
            let grandTotal = 0;

            state.people.forEach(p => personTotals[p.id] = 0);
            
            state.items.forEach(item => {
                const totalCost = item.price * item.qty;
                grandTotal += totalCost;
                
                const totalClaims = item.assignedTo.length;
                if (totalClaims > 0) {
                    if (totalClaims <= item.qty) {
                        const costPerClaim = item.price;
                        item.assignedTo.forEach(pid => { 
                            if (personTotals[pid] !== undefined) personTotals[pid] += costPerClaim;
                        });
                    } else {
                        const costPerClaim = totalCost / totalClaims;
                        item.assignedTo.forEach(pid => { 
                            if (personTotals[pid] !== undefined) personTotals[pid] += costPerClaim;
                        });
                    }
                }
            });

            state.people.forEach(p => {
                if (personTotals[p.id] > 0) {
                    const isPayer = (p.id === state.payerId);
                    debts.push({
                        personId: p.id,
                        name: p.name,
                        amount: personTotals[p.id],
                        isPayer: isPayer,
                        paid: isPayer 
                    });
                }
            });

            if (state.historyId) {
                // Update existing history entry
                const existingIndex = history.findIndex(h => h.id === state.historyId);
                if (existingIndex > -1) {
                    const existingBill = history[existingIndex];
                    
                    // Preserve paid status from old snapshot
                    debts.forEach(newDebt => {
                        const oldDebt = existingBill.participants.find(p => p.personId === newDebt.personId);
                        if (oldDebt && oldDebt.paid) {
                            newDebt.paid = true;
                        }
                    });

                    history[existingIndex] = {
                        ...existingBill,
                        name: state.billName || 'Cuenta sin nombre',
                        total: grandTotal,
                        payerName: state.people.find(p => p.id === state.payerId)?.name || 'Nadie',
                        participants: debts,
                        collabId: state.collabId
                    };
                    
                    state.saved = true;
                    saveState();
                    saveHistory();
                    els.historyBadge.classList.remove('hidden');
                    if (!silent) showToast("Historial actualizado");
                    return;
                }
            }

            // Create new history entry
            const newBillId = generateId();
            const newBill = {
                id: newBillId,
                name: state.billName || 'Cuenta sin nombre',
                date: new Date().toISOString(),
                total: grandTotal,
                payerName: state.people.find(p => p.id === state.payerId)?.name || 'Nadie',
                participants: debts,
                collabId: state.collabId // Add the collaborative link ID
            };

            history.unshift(newBill); 
            state.historyId = newBillId;
            state.saved = true;
            saveState(); // Persist saved state
            saveHistory();
            
            els.historyBadge.classList.remove('hidden');
            if (!silent) showToast("Cuenta guardada en Historial");
        }

        async function syncHistoryBill(historyBillId) {
            const billIndex = history.findIndex(h => h.id === historyBillId);
            if (billIndex === -1) return;
            const bill = history[billIndex];

            if (!bill.collabId) return;

            // UI Inline Loading
            const syncBtn = document.getElementById(`sync-btn-${historyBillId}`);
            if (syncBtn) {
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sincronizando...';
                syncBtn.classList.add('opacity-70', 'cursor-not-allowed');
            }

            try {
                const response = await fetch(`/api/bills/${bill.collabId}`);
                if (!response.ok) throw new Error("No se pudo obtener la cuenta.");
                const serverState = await response.json();

                // Recalculate current debts snapshot using PROPORTIONAL logic based on server state
                const debts = []; 
                const personTotals = {};
                let grandTotal = 0;

                serverState.people.forEach(p => personTotals[p.id] = 0);
                
                serverState.items.forEach(item => {
                    const totalCost = item.price * item.qty;
                    grandTotal += totalCost;
                    const totalClaims = item.assignedTo.length;

                    if (totalClaims > 0) {
                        if (totalClaims <= item.qty) {
                            const costPerClaim = item.price;
                            item.assignedTo.forEach(pid => { 
                                if (personTotals[pid] !== undefined) personTotals[pid] += costPerClaim;
                            });
                        } else {
                            const costPerClaim = totalCost / totalClaims;
                            item.assignedTo.forEach(pid => { 
                                if (personTotals[pid] !== undefined) personTotals[pid] += costPerClaim;
                            });
                        }
                    }
                });

                serverState.people.forEach(p => {
                    if (personTotals[p.id] > 0) {
                        const isPayer = (p.id === serverState.payerId);
                        debts.push({
                            personId: p.id,
                            name: p.name,
                            amount: personTotals[p.id],
                            isPayer: isPayer,
                            paid: isPayer 
                        });
                    }
                });

                // Preserve paid status from old history snapshot
                debts.forEach(newDebt => {
                    const oldDebt = bill.participants.find(p => p.personId === newDebt.personId);
                    if (oldDebt && oldDebt.paid) {
                        newDebt.paid = true;
                    }
                });

                // Update history record
                history[billIndex] = {
                    ...bill,
                    name: serverState.billName || 'Cuenta sin nombre',
                    total: grandTotal,
                    payerName: serverState.people.find(p => p.id === serverState.payerId)?.name || 'Nadie',
                    participants: debts
                };

                // If currently loaded in calculator, also update the active state seamlessly
                if (state.historyId === historyBillId) {
                    state.items.forEach(localItem => {
                        const serverItem = serverState.items.find(i => i.id === localItem.id);
                        if (serverItem) {
                            localItem.assignedTo = serverItem.assignedTo;
                        }
                    });
                    state.saved = true;
                    saveState();
                }

                saveHistory(); 
                showToast("Sincronización completa");
            } catch (error) {
                console.error("Error syncing history:", error);
                alert("Hubo un error al sincronizar la cuenta.");
                // Reset button if error (on success, renderHistory naturally resets it)
                if (syncBtn) {
                    syncBtn.disabled = false;
                    syncBtn.innerHTML = '<i class="fa-solid fa-rotate"></i> Sincronizar Selecciones';
                    syncBtn.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            }
        }

        function togglePayment(billId, personId) {
            const billIndex = history.findIndex(h => h.id === billId);
            if (billIndex === -1) return;

            const participant = history[billIndex].participants.find(p => p.personId === personId);
            if (participant) {
                participant.paid = !participant.paid;
                saveHistory(); 
            }
        }

        function deleteBill(billId) {
            if(confirm("¿Eliminar esta cuenta del historial?")) {
                history = history.filter(h => h.id !== billId);
                if (expandedBillId === billId) expandedBillId = null;
                
                // If it's the current active bill, reset the link internally
                if (state.historyId === billId) {
                    state.historyId = null;
                    state.saved = false;
                    saveState();
                }
                
                saveHistory();
            }
        }

        function toggleAccordion(billId) {
            if (expandedBillId === billId) {
                expandedBillId = null;
            } else {
                expandedBillId = billId;
            }
            renderHistory();
        }

        function renderHistory() {
            els.historyCount.textContent = `${history.length} cuentas`;
            els.historyList.innerHTML = '';

            if (history.length === 0) {
                els.historyList.innerHTML = `
                    <div class="text-center text-gray-400 py-10">
                        <i class="fa-solid fa-clock-rotate-left text-4xl mb-3 opacity-20"></i>
                        <p>No hay cuentas guardadas aún.</p>
                    </div>`;
                return;
            }

            history.forEach(bill => {
                const dateObj = new Date(bill.date);
                const dateStr = dateObj.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                const isExpanded = bill.id === expandedBillId;
                
                // Calculate Progress
                const totalDebt = bill.participants.reduce((sum, p) => sum + p.amount, 0);
                const paidDebt = bill.participants.filter(p => p.paid).reduce((sum, p) => sum + p.amount, 0);
                const percent = totalDebt > 0 ? (paidDebt / totalDebt) * 100 : 0;
                const isFullyPaid = percent >= 99.9;

                // Collaborative Link Banner inside History
                let collabLinkHtml = '';
                if (bill.collabId) {
                    const shareUrl = window.location.origin + '/shared_bill/' + bill.collabId;
                    collabLinkHtml = `
                        <div class="mb-4 bg-blue-50 p-3 rounded-xl border border-blue-100 flex flex-col gap-2 shadow-sm">
                            <div class="flex items-center justify-between gap-2">
                                <div class="truncate flex-1 text-xs text-blue-700 font-medium flex items-center">
                                    <i class="fa-solid fa-link mr-2"></i> Enlace activo
                                </div>
                                <button onclick="window.location.href='${shareUrl}'" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-lg text-[10px] font-bold transition-colors shadow-sm whitespace-nowrap active:scale-95 flex items-center gap-1">
                                    <i class="fa-solid fa-arrow-up-right-from-square"></i> Abrir
                                </button>
                            </div>
                            <div class="border-t border-blue-100 pt-2 mt-1">
                                <button id="sync-btn-${bill.id}" onclick="syncHistoryBill('${bill.id}')" class="w-full bg-white hover:bg-blue-100 text-blue-700 border border-blue-200 px-3 py-2 rounded-lg text-[10px] font-bold transition-colors shadow-sm active:scale-95 flex justify-center items-center gap-2 disabled:active:scale-100">
                                    <i class="fa-solid fa-rotate"></i> Sincronizar Selecciones
                                </button>
                            </div>
                        </div>
                    `;
                }

                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden';
                
                card.innerHTML = `
                    <div class="p-4 cursor-pointer hover:bg-gray-50 transition-colors" onclick="toggleAccordion('${bill.id}')">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <div class="text-xs text-gray-400 font-bold uppercase tracking-wide mb-0.5">${dateStr}</div>
                                <h3 class="font-bold text-gray-800 text-lg leading-tight">${bill.name}</h3>
                                <div class="text-xs text-gray-500 mt-1">Pagado por: <span class="font-medium text-gray-700">${bill.payerName}</span></div>
                            </div>
                            <div class="text-right">
                                <div class="font-mono font-bold text-gray-900 text-lg">${formatCurrency(bill.total)}</div>
                                ${isFullyPaid 
                                    ? '<span class="inline-block bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded-full mt-1">COMPLETADO</span>' 
                                    : `<span class="inline-block bg-gray-100 text-gray-500 text-[10px] font-bold px-2 py-0.5 rounded-full mt-1">${Math.round(percent)}% Pagado</span>`
                                }
                            </div>
                        </div>
                        <!-- Progress Bar -->
                        <div class="w-full bg-gray-100 h-1.5 rounded-full mt-2 overflow-hidden">
                            <div class="bg-secondary h-full rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                        </div>
                    </div>

                    <!-- Details -->
                    <div class="${isExpanded ? '' : 'hidden'} border-t border-gray-100 bg-gray-50 p-4 animate-fade-in">
                        ${collabLinkHtml}
                        <div class="space-y-3">
                            ${bill.participants.map(p => `
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <input type="checkbox" 
                                            class="w-5 h-5 rounded border-gray-300 text-secondary focus:ring-secondary custom-checkbox cursor-pointer"
                                            ${p.paid ? 'checked' : ''}
                                            onchange="togglePayment('${bill.id}', '${p.personId}')">
                                        <div class="${p.paid ? 'line-through text-gray-400' : 'text-gray-700 font-medium'}">
                                            ${p.name}
                                            ${p.isPayer ? '<span class="text-[10px] bg-indigo-100 text-indigo-700 px-1.5 rounded ml-1">Pagador</span>' : ''}
                                        </div>
                                    </div>
                                    <div class="font-mono text-sm ${p.paid ? 'text-gray-400' : 'text-gray-900 font-bold'}">
                                        ${formatCurrency(p.amount)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200 flex justify-end">
                            <button onclick="deleteBill('${bill.id}')" class="text-xs text-red-400 hover:text-red-600 font-medium flex items-center gap-1">
                                <i class="fa-solid fa-trash"></i> Eliminar Cuenta
                            </button>
                        </div>
                    </div>
                `;
                els.historyList.appendChild(card);
            });
        }

        // --- Logic (Calculator) ---

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        const targetW = 748;
                        const targetH = 748;
                        const scale = Math.min(targetW / img.width, targetH / img.height);
                        const newW = Math.round(img.width * scale);
                        const newH = Math.round(img.height * scale);
                        const offsetX = Math.floor((targetW - newW) / 2);
                        const offsetY = Math.floor((targetH - newH) / 2);
                        const canvas = document.createElement('canvas');
                        canvas.width = targetW;
                        canvas.height = targetH;
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#fff';
                        ctx.fillRect(0, 0, targetW, targetH);
                        ctx.drawImage(img, offsetX, offsetY, newW, newH);
                        resolve(canvas.toDataURL('image/jpeg', 0.92));
                    };
                    img.onerror = (e) => reject(e);
                    img.src = reader.result;
                };
                reader.onerror = error => reject(error);
            });
        }

        async function handleBillUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const imageFile = await fileToBase64(file)
                showLoading("Analizando Recibo");
                try {
                    const response = await fetch('/process-receipt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: imageFile })
                    });
                    if (!response.ok) throw new Error(`Server Error: ${response.statusText}`);
                    const data = await response.json();
                    processBackendResponse(data);
                } catch (error) {
                    console.error('Error:', error);
                    alert("Fallo al analizar el recibo. " + error.message);
                } finally {
                    hideLoading();
                    input.value = ''; 
                }
            }
        }

        function processBackendResponse(data) {
            if (!data || !Array.isArray(data.items)) {
                alert("Formato de respuesta inválido.");
                return;
            }
            const items = data.items;
            let count = 0;
            const newItems = [];
            items.forEach(entry => {
                if (entry && entry.item && entry.price) {
                    const price = parseFloat(entry.price.replace(",", "."));
                    const qty = parseInt(entry.quantity) || 1;
                    if (!isNaN(price)) {
                        newItems.push({
                            id: generateId(),
                            name: entry.item,
                            price: price,
                            qty: qty,
                            assignedTo: [] 
                        });
                        count++;
                    }
                }
            });
            state.items = [...state.items, ...newItems];
            state.saved = false;
            saveState();
            showToast(`¡Añadidos ${count} artículos!`);
        }

        function addPerson() {
            const name = els.personInput.value.trim();
            if (!name) return;
            const newPerson = { id: generateId(), name: name };
            state.people.push(newPerson);
            els.personInput.value = '';
            showToast(`${name} añadido/a`);
            state.saved = false;
            saveState();
        }

        function removePerson(id) {
            state.people = state.people.filter(p => p.id !== id);
            state.items.forEach(item => {
                item.assignedTo = item.assignedTo.filter(pid => pid !== id);
            });
            if (state.payerId === id) state.payerId = '';
            state.saved = false;
            saveState();
        }

        function adjustQty(delta) {
            const current = parseInt(els.itemQty.value) || 0;
            const newVal = Math.max(1, current + delta);
            els.itemQty.value = newVal;
        }

        function addItem() {
            const name = els.itemName.value.trim();
            const price = parseFloat(els.itemPrice.value);
            const qty = parseInt(els.itemQty.value);

            if (!name || isNaN(price) || isNaN(qty) || qty < 1) {
                alert("Datos inválidos.");
                return;
            }

            const newItem = {
                id: generateId(),
                name,
                price,
                qty,
                assignedTo: [] 
            };

            state.items.push(newItem);
            els.itemName.value = '';
            els.itemPrice.value = '';
            els.itemQty.value = '1';
            els.itemName.focus();
            showToast('Artículo añadido');
            state.saved = false;
            saveState();
        }

        function removeItem(id) {
            state.items = state.items.filter(i => i.id !== id);
            state.saved = false;
            saveState();
        }

        function smartSplitItem(id) {
            const index = state.items.findIndex(i => i.id === id);
            if (index === -1) return;
            const item = state.items[index];
            if (item.qty <= 1) return;

            state.items.splice(index, 1);
            const newItems = [];
            for(let i=0; i<item.qty; i++) {
                newItems.push({
                    id: generateId(),
                    name: item.name,
                    price: item.price,
                    qty: 1,
                    assignedTo: [...item.assignedTo] 
                });
            }
            state.items.splice(index, 0, ...newItems);
            state.saved = false;
            saveState();
            showToast(`Desglosado en ${item.qty} unidades`);
        }

        function startEdit(id) {
            editingItemId = id;
            render();
        }

        function cancelEdit() {
            editingItemId = null;
            render();
        }

        function saveEdit(id) {
            const nameInput = document.getElementById(`edit-name-${id}`);
            const priceInput = document.getElementById(`edit-price-${id}`);
            const qtyInput = document.getElementById(`edit-qty-${id}`);
            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value);
            const qty = parseInt(qtyInput.value);

            if (!name || isNaN(price) || isNaN(qty) || qty < 1) return;

            const itemIndex = state.items.findIndex(i => i.id === id);
            if (itemIndex > -1) {
                state.items[itemIndex].name = name;
                state.items[itemIndex].price = price;
                state.items[itemIndex].qty = qty;
                showToast("Actualizado");
            }
            editingItemId = null;
            state.saved = false;
            saveState();
        }

        function toggleAssignment(itemId, personId) {
            const item = state.items.find(i => i.id === itemId);
            if (!item) return;
            if (item.assignedTo.includes(personId)) {
                item.assignedTo = item.assignedTo.filter(id => id !== personId);
            } else {
                item.assignedTo.push(personId);
            }
            state.saved = false;
            saveState();
        }

        function toggleAllAssignment(itemId) {
            const item = state.items.find(i => i.id === itemId);
            if (!item) return;
            const allSelected = state.people.every(p => item.assignedTo.includes(p.id));
            if (allSelected) {
                item.assignedTo = [];
            } else {
                item.assignedTo = state.people.map(p => p.id);
            }
            state.saved = false;
            saveState();
        }

        function toggleAssignmentForGroup(itemIds) {
            const items = state.items.filter(i => itemIds.includes(i.id));
            if(items.length === 0 || state.people.length === 0) return;
            const allFull = items.every(item => state.people.every(p => item.assignedTo.includes(p.id)));
            items.forEach(item => {
                if (allFull) { item.assignedTo = []; } 
                else { item.assignedTo = state.people.map(p => p.id); }
            });
            state.saved = false;
            saveState();
        }

        async function shareReceipt() {
            showLoading("Generando Imagen");
            const originalShadow = els.receiptCard.style.boxShadow;
            els.receiptCard.style.boxShadow = 'none';
            els.receiptCard.style.backgroundColor = '#ffffff';

            try {
                const canvas = await html2canvas(els.receiptCard, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true
                });
                els.receiptCard.style.boxShadow = originalShadow;

                if (window.Android && window.Android.shareImage) {
                    window.Android.shareImage(canvas.toDataURL('image/png'));
                    showToast('Abriendo app...');
                    hideLoading();
                    return;
                }

                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const file = new File([blob], "recibo_splitio.png", { type: "image/png" });
                const shareData = { files: [file], title: state.billName || 'Cuenta Splitio' };

                if (navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                    showToast('¡Compartido!');
                } else {
                    downloadImage(canvas);
                }
            } catch (err) {
                console.error(err);
                alert("Error al generar imagen.");
            } finally {
                hideLoading();
            }
        }

        function downloadImage(canvas) {
            const link = document.createElement('a');
            link.download = `receipt_${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showToast('Descargado');
        }

        function formatCurrency(num) {
            return new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' }).format(num);
        }

        function renderPeople() {
            els.peopleList.innerHTML = '';
            els.payerSelect.innerHTML = '<option value="">¿Quién pagó?</option>';
            if (state.people.length === 0) {
                els.emptyPeopleMsg.style.display = 'block';
                return;
            }
            els.emptyPeopleMsg.style.display = 'none';
            state.people.forEach(person => {
                const chip = document.createElement('div');
                chip.className = 'bg-gray-100 border border-gray-200 text-gray-800 rounded-full px-3 py-1 text-sm flex items-center gap-2 animate-fade-in';
                chip.innerHTML = `
                    <span class="font-medium truncate max-w-[100px]">${person.name}</span>
                    <button onclick="removePerson('${person.id}')" class="text-gray-400 hover:text-red-500 rounded-full w-4 h-4 flex items-center justify-center"><i class="fa-solid fa-times text-xs"></i></button>
                `;
                els.peopleList.appendChild(chip);
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                if (person.id === state.payerId) option.selected = true;
                els.payerSelect.appendChild(option);
            });
        }

        function renderItems() {
            els.itemsList.innerHTML = '';
            if (state.items.length === 0) {
                els.emptyItemsMsg.style.display = 'block';
                return;
            }
            els.emptyItemsMsg.style.display = 'none';

            const groupedData = [];
            const processedIds = new Set();
            state.items.forEach(item => {
                if (processedIds.has(item.id)) return;
                const key = `${item.name.toLowerCase().trim()}|${item.price}`;
                const groupItems = state.items.filter(i => `${i.name.toLowerCase().trim()}|${i.price}` === key);
                if (groupItems.length > 1) {
                     const isAlreadyAdded = groupedData.some(g => g.key === key);
                     if (!isAlreadyAdded) {
                         groupedData.push({ type: 'group', key: key, items: groupItems });
                         groupItems.forEach(i => processedIds.add(i.id));
                     }
                } else {
                    groupedData.push({ type: 'single', item: item });
                    processedIds.add(item.id);
                }
            });

            groupedData.forEach(groupObj => {
                if (groupObj.type === 'single') renderSingleItem(groupObj.item);
                else renderGroupItems(groupObj.items);
            });
        }

        function renderGroupItems(items) {
            const firstItem = items[0];
            const totalQty = items.reduce((sum, i) => sum + i.qty, 0);
            const container = document.createElement('div');
            container.className = 'bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm mb-3';
            container.innerHTML = `
                <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <span class="bg-indigo-100 text-indigo-700 text-[10px] font-bold px-2 py-0.5 rounded-full">x${totalQty}</span>
                        <h3 class="font-bold text-gray-800 text-sm">${firstItem.name}</h3>
                    </div>
                    <button onclick="toggleAssignmentForGroup([${items.map(i => `'${i.id}'`).join(',')}])" class="text-[10px] font-bold text-primary hover:text-indigo-700 uppercase tracking-wide">Asignar Todos</button>
                </div>
            `;
            const list = document.createElement('div');
            list.className = 'divide-y divide-gray-50';
            
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'p-3 hover:bg-gray-50 transition-colors';
                if (editingItemId === item.id) {
                    renderEditRow(row, item);
                } else {
                    renderNormalRow(row, item);
                }
                list.appendChild(row);
            });
            container.appendChild(list);
            els.itemsList.appendChild(container);
        }

        function renderSingleItem(item) {
            if (editingItemId === item.id) {
                const div = document.createElement('div');
                div.className = 'bg-white border-2 border-primary rounded-xl p-4 shadow-md relative mb-3';
                div.innerHTML = `
                    <div class="space-y-3">
                        <div class="flex justify-between items-center mb-2"><h3 class="text-xs font-bold text-primary uppercase tracking-wide">Editando</h3></div>
                        <div><input type="text" id="edit-name-${item.id}" value="${item.name}" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary"></div>
                        <div class="flex gap-3">
                            <div class="flex-1"><input type="number" id="edit-price-${item.id}" value="${item.price}" step="0.01" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary"></div>
                            <div class="w-24"><input type="number" id="edit-qty-${item.id}" value="${item.qty}" min="1" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-primary"></div>
                        </div>
                        <div class="flex justify-end gap-2 pt-2">
                            <button onclick="cancelEdit()" class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-xs font-bold">Cancelar</button>
                            <button onclick="saveEdit('${item.id}')" class="px-4 py-2 bg-primary text-white rounded-lg text-xs font-bold shadow-sm">Guardar</button>
                        </div>
                    </div>`;
                els.itemsList.appendChild(div);
                return;
            }
            const div = document.createElement('div');
            div.className = `bg-white border ${item.assignedTo.length===0 ? 'border-orange-200' : 'border-gray-100'} rounded-xl p-4 shadow-sm transition-all hover:shadow-md relative mb-3`;
            renderNormalCard(div, item);
            els.itemsList.appendChild(div);
        }

        function renderEditRow(container, item) {
            container.innerHTML = `
                <div class="space-y-2">
                    <div class="flex gap-2">
                        <input type="text" id="edit-name-${item.id}" value="${item.name}" class="flex-1 bg-white border border-gray-200 rounded px-2 py-1 text-xs outline-none focus:border-primary">
                        <input type="number" id="edit-price-${item.id}" value="${item.price}" step="0.01" class="w-20 bg-white border border-gray-200 rounded px-2 py-1 text-xs outline-none focus:border-primary">
                        <input type="number" id="edit-qty-${item.id}" value="${item.qty}" min="1" class="w-12 bg-white border border-gray-200 rounded px-2 py-1 text-xs outline-none focus:border-primary">
                    </div>
                    <div class="flex justify-end gap-2">
                        <button onclick="cancelEdit()" class="text-[10px] text-gray-500">Cancelar</button>
                        <button onclick="saveEdit('${item.id}')" class="text-[10px] text-white bg-primary px-2 py-1 rounded">Guardar</button>
                    </div>
                </div>`;
        }

        function renderNormalRow(container, item) {
            const isUnassigned = item.assignedTo.length === 0;
            let assignmentHtml = '';
            if (state.people.length === 0) assignmentHtml = `<span class="text-[10px] text-gray-300 italic">Añade personas</span>`;
            else {
                state.people.forEach(person => {
                    const isAssigned = item.assignedTo.includes(person.id);
                    assignmentHtml += `<button onclick="toggleAssignment('${item.id}', '${person.id}')" class="text-[10px] px-2 py-1 rounded border transition-all ${isAssigned ? 'bg-indigo-50 border-primary text-primary font-bold' : 'bg-white border-gray-200 text-gray-400'}">${person.name}</button>`;
                });
            }
            container.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-mono text-gray-500">${formatCurrency(item.price)}</span>
                        ${isUnassigned && state.people.length > 0 ? '<i class="fa-solid fa-circle-exclamation text-[10px] text-orange-400"></i>' : ''}
                    </div>
                    <div class="flex items-center gap-1">
                        <button onclick="startEdit('${item.id}')" class="text-gray-300 hover:text-blue-500 px-1"><i class="fa-solid fa-pen text-[10px]"></i></button>
                        <button onclick="removeItem('${item.id}')" class="text-gray-300 hover:text-red-500 px-1"><i class="fa-solid fa-trash text-[10px]"></i></button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-1">${assignmentHtml}</div>
            `;
        }

        function renderNormalCard(container, item) {
            const totalCost = item.price * item.qty;
            const isUnassigned = item.assignedTo.length === 0;
            const canSplit = item.qty > 1;
            let html = `
                <div class="flex justify-between items-start mb-2">
                    <div class="pr-2">
                        <h3 class="font-bold text-gray-900 leading-tight">${item.name}</h3>
                        <div class="text-xs text-gray-500 mt-1">${item.qty} x ${formatCurrency(item.price)}</div>
                    </div>
                    <div class="text-right whitespace-nowrap">
                        <div class="font-mono font-bold text-gray-800">${formatCurrency(totalCost)}</div>
                        <div class="flex gap-1 justify-end mt-1 items-center">
                            <button onclick="startEdit('${item.id}')" class="text-xs text-blue-400 hover:text-blue-600 px-1.5 py-1 rounded hover:bg-blue-50 transition-colors"><i class="fa-solid fa-pen"></i></button>
                            ${canSplit ? `<button onclick="smartSplitItem('${item.id}')" class="text-xs text-indigo-400 hover:text-indigo-600 px-1.5 py-1 rounded hover:bg-indigo-50 transition-colors"><i class="fa-solid fa-expand"></i></button>` : ''}
                            <button onclick="removeItem('${item.id}')" class="text-xs text-red-300 hover:text-red-500 px-1.5 py-1 rounded hover:bg-red-50 transition-colors"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>`;
            if (isUnassigned && state.people.length > 0) html += `<div class="text-[10px] text-orange-500 font-bold mb-2 flex items-center"><i class="fa-solid fa-triangle-exclamation mr-1"></i> ¡Sin asignar!</div>`;
            html += `<div class="border-t border-gray-50 pt-3">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-gray-400 uppercase font-semibold">Compartido por:</span>
                            <button onclick="toggleAllAssignment('${item.id}')" class="text-[10px] text-primary hover:underline">Todos</button>
                        </div>
                        <div class="flex flex-wrap gap-2">`;
            if (state.people.length === 0) html += `<span class="text-xs text-gray-400 italic">Añade personas.</span>`;
            else {
                state.people.forEach(person => {
                    const isAssigned = item.assignedTo.includes(person.id);
                    html += `<button onclick="toggleAssignment('${item.id}', '${person.id}')" class="text-xs px-2.5 py-1.5 rounded-lg border transition-all duration-200 ${isAssigned ? 'bg-indigo-50 border-primary text-primary font-medium shadow-sm ring-1 ring-primary ring-opacity-10' : 'bg-white border-gray-200 text-gray-400 hover:border-gray-300'}">${person.name}</button>`;
                });
            }
            html += `</div></div>`;
            container.innerHTML = html;
        }

        function renderReceipt() {
            const personTotals = {}; 
            let grandTotal = 0;
            let unclaimedTotal = 0;

            state.people.forEach(p => personTotals[p.id] = 0);

            state.items.forEach(item => {
                const totalCost = item.price * item.qty;
                grandTotal += totalCost;
                
                const totalClaims = item.assignedTo.length;

                if (totalClaims === 0) {
                    unclaimedTotal += totalCost;
                } else if (totalClaims <= item.qty) {
                    const costPerClaim = item.price;
                    item.assignedTo.forEach(pid => { 
                        if (personTotals[pid] !== undefined) personTotals[pid] += costPerClaim;
                    });
                    unclaimedTotal += (item.qty - totalClaims) * item.price;
                } else {
                    const costPerClaim = totalCost / totalClaims;
                    item.assignedTo.forEach(pid => { 
                        if (personTotals[pid] !== undefined) personTotals[pid] += costPerClaim;
                    });
                }
            });

            els.receiptBillName.textContent = state.billName || 'CUENTA TOTAL';
            els.grandTotalDisplay.textContent = formatCurrency(grandTotal);
            const payer = state.people.find(p => p.id === state.payerId);
            if (payer) {
                els.payerBadge.classList.remove('hidden');
                els.payerBadge.classList.add('inline-block');
                els.payerBadgeName.textContent = payer.name;
            } else {
                els.payerBadge.classList.add('hidden');
                els.payerBadge.classList.remove('inline-block');
            }

            els.receiptContent.innerHTML = '';
            if (state.people.length === 0 && state.items.length === 0) {
                els.receiptContent.innerHTML = `<div class="text-center text-gray-400 italic text-sm py-4">Añade personas y artículos para ver la división.</div>`;
                els.settlementSection.classList.add('hidden');
                return;
            }

            state.people.forEach(person => {
                const amount = personTotals[person.id];
                const personItems = state.items.filter(i => i.assignedTo.includes(person.id));
                const div = document.createElement('div');
                div.className = 'border-b border-gray-100 pb-3 last:border-0';
                
                let detailsHtml = '';
                if (personItems.length > 0) {
                    detailsHtml = `<div class="mt-1 pl-2 border-l-2 border-gray-100 space-y-1">${personItems.map(i => {
                        const totalClaims = i.assignedTo.length;
                        const myCount = i.assignedTo.filter(id => id === person.id).length;
                        
                        let share = 0;
                        if (totalClaims <= i.qty) {
                            share = myCount * i.price;
                        } else {
                            share = myCount * ((i.price * i.qty) / totalClaims);
                        }
                        
                        const portionText = myCount > 1 ? `	(x${myCount})` :`(x1)`;

                        return `<div class="flex justify-between text-xs text-gray-500"><span class="truncate w-3/4">${i.name} ${portionText}</span><span>${formatCurrency(share)}</span></div>`
                    }).join('')}</div>`;
                }
                div.innerHTML = `<div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-800">${person.name}</span><span class="font-mono font-bold text-lg ${amount > 0 ? 'text-primary' : 'text-gray-400'}">${formatCurrency(amount)}</span></div>${detailsHtml}`;
                els.receiptContent.appendChild(div);
            });

            if (unclaimedTotal > 0.01) {
                const div = document.createElement('div');
                div.className = 'mt-4 bg-orange-50 p-3 rounded-lg border border-orange-100';
                div.innerHTML = `<div class="flex justify-between items-center text-orange-700 font-bold text-sm"><span><i class="fa-solid fa-circle-exclamation mr-1"></i> Artículos Sin Asignar</span><span>${formatCurrency(unclaimedTotal)}</span></div>`;
                els.receiptContent.appendChild(div);
            }

            if (payer) {
                els.settlementSection.classList.remove('hidden');
                els.settlementList.innerHTML = '';
                let hasDebts = false;
                state.people.forEach(person => {
                    if (person.id === payer.id) return;
                    const amountOwed = personTotals[person.id];
                    if (amountOwed > 0) {
                        hasDebts = true;
                        const row = document.createElement('div');
                        row.innerHTML = `<span class="font-bold text-gray-800">${person.name}</span> debe a ${payer.name} <span class="font-bold text-primary">${formatCurrency(amountOwed)}</span>`;
                        els.settlementList.appendChild(row);
                    }
                });
                if (!hasDebts) els.settlementList.innerHTML = `<div class="text-xs text-gray-400 italic">No hay deudas que saldar.</div>`;
            } else {
                els.settlementSection.classList.add('hidden');
            }

            // Save Button Visibility Logic
            if (state.saved) {
                els.saveBillBtn.classList.add('hidden');
                els.actionButtonsGrid.classList.remove('grid-cols-2');
                els.actionButtonsGrid.classList.add('grid-cols-1');
            } else {
                els.saveBillBtn.classList.remove('hidden');
                els.actionButtonsGrid.classList.add('grid-cols-2');
                els.actionButtonsGrid.classList.remove('grid-cols-1');
                
                // Change text if updating
                if (state.historyId) {
                    els.saveBillBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Actualizar';
                } else {
                    els.saveBillBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Guardar';
                }
            }
        }

        // Add this missing function
        function render() {
            renderPeople();
            renderItems();
            renderReceipt();
            renderCollabUI();
        }

        render();
        renderHistory();
    </script>
</body>
</html>